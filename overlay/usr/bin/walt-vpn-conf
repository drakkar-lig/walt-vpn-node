#!/bin/sh

USAGE="Usage: $0 --entrypoint"

if [ "$1" != "--entrypoint" ]
then
    echo "$USAGE" >&2
    exit 1
fi

{
    flock 200
    mkdir -p /run/p1
    mount -o ro /dev/mmcblk0p1 /run/p1

    if [ -f "/run/p1/walt-vpn.conf" ]
    then
        source /run/p1/walt-vpn.conf
        echo "$WALT_VPN_ENTRYPOINT"
    else
        echo "Missing file walt-vpn.conf on first SD card partition!" >&2
    fi

    umount /run/p1
    rmdir /run/p1

    if [ "$WALT_VPN_ENTRYPOINT" = "" ]
    then
        exit 2
    else
        exit 0  # ok
    fi
} 200>/run/walt-vpn-conf.lock

